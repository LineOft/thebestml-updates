<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Game Store</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%);
        }
        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            z-index: 9999;
            background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%);
        }
        .logo {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-radius: 25px;
            margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }
        h1 {
            font-size: 28px; margin-bottom: 5px;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 30px; }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(76, 175, 80, 0.2);
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status { color: #aaa; font-size: 14px; }
        .progress-bar {
            width: 250px; height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }
        #appFrame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .error-box {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .error-box h3 { color: #f44336; margin-bottom: 15px; }
        .error-box p { color: #888; margin-bottom: 20px; }
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff; border: none;
            padding: 12px 30px; border-radius: 20px;
            font-size: 14px; cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="logo">🎮</div>
        <h1>Game Store</h1>
        <p class="subtitle">Oyun Modları & Kurulum Rehberleri</p>
        <div class="spinner"></div>
        <p id="status">Başlatılıyor...</p>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        
        <div class="error-box" id="errorBox">
            <h3>⚠️ Bağlantı Hatası</h3>
            <p id="errorMsg">Sunucuya bağlanılamadı</p>
            <button class="btn" onclick="location.reload()">🔄 Tekrar Dene</button>
        </div>
    </div>
    
    <iframe id="appFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>

    <script>
        var GITHUB = 'https://raw.githubusercontent.com/LineOft/thebestml-updates/main/';
        var JSDELIVR = 'https://cdn.jsdelivr.net/gh/LineOft/thebestml-updates@main/';
        var CACHE_KEY = 'ota_app_html';
        var VERSION_KEY = 'ota_app_version';
        var MIN_VERSION = '3.14.90'; // Bu versiyondan düşükse cache temizle
        
        // Eski cache temizleme
        (function() {
            var cached = localStorage.getItem(VERSION_KEY);
            if (cached) {
                var cp = cached.split('.').map(Number);
                var mp = MIN_VERSION.split('.').map(Number);
                var needsClear = false;
                
                for (var i = 0; i < Math.max(cp.length, mp.length); i++) {
                    var c = cp[i] || 0, m = mp[i] || 0;
                    if (c < m) { needsClear = true; break; }
                    if (c > m) break;
                }
                
                if (needsClear) {
                    console.log('[OTA] Eski cache temizleniyor: v' + cached);
                    localStorage.removeItem(CACHE_KEY);
                    localStorage.removeItem(VERSION_KEY);
                }
            }
        })();
        
        function status(t) { document.getElementById('status').textContent = t; }
        function progress(p) { document.getElementById('progress').style.width = p + '%'; }
        
        function showError(msg) {
            document.querySelector('.spinner').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorMsg').textContent = msg;
        }
        
        function loadApp(html) {
            console.log('[OTA] Uygulama yükleniyor...');
            progress(100);
            status('Yükleniyor...');
            
            setTimeout(function() {
                var frame = document.getElementById('appFrame');
                frame.srcdoc = html;
                
                frame.onload = function() {
                    console.log('[OTA] Frame yüklendi');
                    document.getElementById('loader').style.display = 'none';
                    frame.style.display = 'block';
                };
                
                // 5 saniye timeout
                setTimeout(function() {
                    if (document.getElementById('loader').style.display !== 'none') {
                        document.getElementById('loader').style.display = 'none';
                        frame.style.display = 'block';
                    }
                }, 5000);
            }, 300);
        }
        
        function isNewer(v1, v2) {
            var p1 = (v1 || '0').split('.').map(Number);
            var p2 = (v2 || '0').split('.').map(Number);
            for (var i = 0; i < Math.max(p1.length, p2.length); i++) {
                var a = p1[i] || 0, b = p2[i] || 0;
                if (a > b) return true;
                if (a < b) return false;
            }
            return false;
        }

        function extractAppVersion(html) {
            try {
                var m = String(html || '').match(/APP_VERSION\s*=\s*['\"]([^'\"]+)['\"]/);
                return m ? m[1] : null;
            } catch (e) {
                return null;
            }
        }

        function isValidAppHtml(html) {
            return !!(html && html.length > 5000 && html.indexOf('APP_VERSION') !== -1);
        }

        function noStoreHeaders(isApi) {
            if (isApi) {
                return {
                    'Cache-Control': 'no-cache',
                    'Accept': 'application/vnd.github.v3.raw'
                };
            }
            return {
                'Cache-Control': 'no-store, no-cache, max-age=0',
                'Pragma': 'no-cache'
            };
        }

        function fetchTextWithNoCache(url) {
            var isApi = url.indexOf('api.github.com') !== -1;
            return fetch(url, { cache: 'no-store', headers: noStoreHeaders(isApi) })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); });
        }

        function fetchJsonWithNoCache(url) {
            var isApi = url.indexOf('api.github.com') !== -1;
            return fetch(url, { cache: 'no-store', headers: noStoreHeaders(isApi) })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
                .then(function(t) { return JSON.parse(t); });
        }

        function fetchManifestNoCache() {
            var ts = Date.now();
            var r = Math.random().toString(36).slice(2);

            var urls = [
                JSDELIVR + 'manifest.json?t=' + ts + '&r=' + r,
                GITHUB + 'manifest.json?t=' + ts + '&r=' + r,
                'https://api.github.com/repos/LineOft/thebestml-updates/contents/manifest.json?t=' + ts + '&r=' + r
            ];

            var i = 0;
            function next() {
                if (i >= urls.length) return Promise.reject(new Error('Manifest alınamadı'));
                var url = urls[i++];
                return fetchJsonWithNoCache(url).catch(function() { return next(); });
            }
            return next();
        }

        function downloadLatestAppHtml(serverVersion) {
            var ts = Date.now();
            var r = Math.random().toString(36).slice(2);

            var urls = [
                JSDELIVR + 'app.html?t=' + ts + '&r=' + r,
                GITHUB + 'app.html?t=' + ts + '&r=' + r,
                'https://api.github.com/repos/LineOft/thebestml-updates/contents/app.html?t=' + ts + '&r=' + r
            ];

            var i = 0;
            function tryNext() {
                if (i >= urls.length) return Promise.reject(new Error('Güncelleme indirilemedi'));
                var url = urls[i++];
                return fetchTextWithNoCache(url)
                    .then(function(html) {
                        if (!isValidAppHtml(html)) throw new Error('Geçersiz içerik');
                        var v = extractAppVersion(html);
                        if (!v) throw new Error('Sürüm okunamadı');
                        // CDN bazen eski blob döndürebiliyor; manifest sürümünden eskiyse kabul etme.
                        if (serverVersion && isNewer(serverVersion, v)) throw new Error('Stale içerik (' + v + ')');
                        return { html: html, version: v };
                    })
                    .catch(function() { return tryNext(); });
            }

            return tryNext();
        }
        
        function init() {
            console.log('[OTA] Başlatılıyor...');
            status('Güncelleme kontrol ediliyor...');
            progress(10);
            
            var cachedVersion = localStorage.getItem(VERSION_KEY) || '0';
            var cachedHtml = localStorage.getItem(CACHE_KEY);

            // Eski loader bug'ı nedeniyle VERSION_KEY ile HTML içindeki APP_VERSION
            // uyuşmayabiliyordu. Bu durumda version'ı HTML'den türetip düzelt.
            try {
                var derivedVersion = null;
                if (cachedHtml && cachedHtml.length > 5000) {
                    derivedVersion = extractAppVersion(cachedHtml);
                }

                // HTML bozuksa cache'i temizle (sonraki adımda yeniden indirilecek)
                if (cachedHtml && cachedHtml.length > 5000 && !derivedVersion) {
                    console.log('[OTA] Cache bozuk (APP_VERSION okunamadı), temizleniyor');
                    localStorage.removeItem(CACHE_KEY);
                    cachedHtml = null;
                }

                if (derivedVersion && derivedVersion !== cachedVersion) {
                    console.log('[OTA] Cache sürüm uyuşmuyor (key=' + cachedVersion + ', html=' + derivedVersion + '), düzeltildi');
                    cachedVersion = derivedVersion;
                    localStorage.setItem(VERSION_KEY, derivedVersion);
                }
            } catch (e) {}
            
            console.log('[OTA] Cache versiyonu:', cachedVersion);
            
            // Manifest kontrol
            fetchManifestNoCache()
                .then(function(manifest) {
                    progress(30);
                    var serverVersion = manifest.version || '0';
                    console.log('[OTA] Sunucu versiyonu:', serverVersion);
                    status('Sunucu: v' + serverVersion);
                    
                    if (isNewer(serverVersion, cachedVersion)) {
                        // Güncelleme var
                        console.log('[OTA] Güncelleme mevcut!');
                        status('Güncelleme indiriliyor...');
                        progress(50);
                        
                        downloadLatestAppHtml(serverVersion)
                            .then(function(result) {
                                progress(80);
                                localStorage.setItem(CACHE_KEY, result.html);
                                localStorage.setItem(VERSION_KEY, result.version);
                                console.log('[OTA] Cache güncellendi: v' + result.version);
                                loadApp(result.html);
                            })
                            .catch(function(e) {
                                console.error('[OTA] İndirme hatası:', e);
                                if (cachedHtml && cachedHtml.length > 5000) {
                                    loadApp(cachedHtml);
                                } else {
                                    showError('İndirme hatası: ' + e.message);
                                }
                            });
                    } else {
                        // Güncel
                        console.log('[OTA] Uygulama güncel');
                        status('Yükleniyor...');
                        progress(80);
                        
                        if (cachedHtml && cachedHtml.length > 5000) {
                            loadApp(cachedHtml);
                        } else {
                            // Cache boş, indir
                            status('İlk yükleme...');
                            downloadLatestAppHtml(serverVersion)
                                .then(function(result) {
                                    localStorage.setItem(CACHE_KEY, result.html);
                                    localStorage.setItem(VERSION_KEY, result.version);
                                    loadApp(result.html);
                                })
                                .catch(function(e) {
                                    showError('Yükleme hatası: ' + e.message);
                                });
                        }
                    }
                })
                .catch(function(e) {
                    console.error('[OTA] Manifest hatası:', e);
                    status('Çevrimdışı mod...');
                    
                    if (cachedHtml && cachedHtml.length > 5000) {
                        loadApp(cachedHtml);
                    } else {
                        showError('İnternet bağlantısı gerekli');
                    }
                });
        }
        
        // Başlat
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
